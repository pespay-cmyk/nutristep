{% extends "base.html" %}

{% block title %}Récap - NutriStep{% endblock %}

{% block extra_css %}
<style>
    .period-selector {
        display: flex;
        gap: 20px;
        align-items: end;
        margin-bottom: 32px;
        flex-wrap: wrap;
    }

    .period-selector .form-group {
        margin-bottom: 0;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }

    .summary-card {
        background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
        color: white;
        padding: 20px;
        border-radius: 16px;
        text-align: center;
    }

    .summary-card h3 {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .summary-card .value {
        font-size: 32px;
        font-weight: 800;
    }

    .recap-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 20px;
        font-size: 14px;
    }

    .recap-table thead th {
        background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
        color: white;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .recap-table thead th:first-child {
        border-radius: 12px 0 0 0;
    }

    .recap-table thead th:last-child {
        border-radius: 0 12px 0 0;
    }

    .recap-table tbody tr {
        background: white;
        border-bottom: 2px solid var(--bg-gradient-start);
    }

    .recap-table tbody tr:hover {
        background: var(--bg-gradient-start);
    }

    .recap-table tbody td {
        padding: 16px 12px;
        vertical-align: top;
    }

    .date-cell {
        font-weight: 700;
        color: var(--text-primary);
        white-space: nowrap;
        min-width: 120px;
    }

    .date-cell .day-name {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        display: block;
        margin-top: 4px;
    }

    .date-cell.today {
        background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
        color: white;
        border-radius: 8px;
        padding: 8px 12px;
    }

    .date-cell.today .day-name {
        color: rgba(255,255,255,0.9);
    }

    .meal-cell {
        line-height: 1.6;
    }

    .meal-name {
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .meal-foods {
        color: #6b7280;
        font-size: 13px;
        margin-left: 24px;
    }

    .meal-foods li {
        margin-bottom: 2px;
    }

    .meal-none {
        color: #9ca3af;
        font-style: italic;
        font-size: 13px;
        margin-left: 24px;
    }

    .qualification-badge-small {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 10px;
        font-weight: bold;
    }

    .qualification-badge-small.exception {
        background: #f59e0b;
        color: white;
    }

    .qualification-badge-small.equilibrage {
        background: #3b82f6;
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
    }

    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    @media print {
        .navbar, .actions-bar, .btn {
            display: none !important;
        }

        body {
            background: white;
            padding: 0;
        }

        .card {
            box-shadow: none;
            border: 1px solid #e5e7eb;
        }

        .recap-table thead th {
            background: #f3f4f6 !important;
            color: #1f2937 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }

    /* RESPONSIVE MOBILE */
    @media (max-width: 768px) {
        h1 {
            font-size: 24px !important;
        }

        .card {
            padding: 12px 8px !important;
            overflow-x: auto !important;
        }

        .recap-table {
            width: 100% !important;
            min-width: auto !important;
            table-layout: auto !important;
        }

        .recap-table thead th,
        .recap-table tbody td {
            padding: 6px 3px !important;
        }
        /* Colonnes flexibles selon contenu */
        .date-cell {
            width: 40px !important;
        }

        .meal-cell {
            width: auto !important;
            min-width: 60px !important;
        }

        .period-selector {
            flex-direction: column;
            align-items: stretch;
        }

        .period-selector button {
            width: 100%;
        }

        .summary-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .summary-card .value {
            font-size: 24px;
        }

        /* Tableau optimisé mobile */
        .recap-table {
            font-size: 11px;
        }

        .recap-table thead th,
        .recap-table tbody td {
            padding: 6px 2px !important;
        }

        /* DATE EN VERTICAL - Tête à GAUCHE (sens naturel de lecture) */
        .date-cell {
            min-width: 35px !important;
            max-width: 35px !important;
            writing-mode: vertical-rl !important;
            text-orientation: mixed !important;
            transform: rotate(180deg) !important; /* ← Inverse pour lire tête à gauche */
            font-size: 11px !important;
            font-weight: 700 !important;
            padding: 8px 2px !important;
            white-space: nowrap !important;
        }

        .date-cell .day-name {
            display: none !important; /* Masque "LUNDI" */
        }

        /* REPAS - Masquer coche verte sur mobile */
        .meal-name span[style*="color: #10b981"] {
            display: none !important;
        }

        /* REPAS - Forcer retours à la ligne */
        .meal-cell {
            max-width: 70px !important;
        }

        .meal-cell ul.meal-foods {
            font-size: 9px !important;
            line-height: 1.3 !important;
        }

        .meal-cell ul.meal-foods li {
            word-break: break-word !important;
            white-space: normal !important;
            overflow-wrap: break-word !important;
        }

        /* ACTIVITÉS - UNIQUEMENT ICÔNES (masquer tout le texte) */
        .meal-cell > div > div {
            font-size: 0 !important; /* Masque texte */
        }

        .meal-cell > div > div svg {
            font-size: initial !important;
            width: 18px !important;
            height: 18px !important;
            display: inline-block !important;
        }

        /* Masquer toutes les infos texte des activités (durée, calories, pas) */
        .meal-cell > div > div + div {
            display: none !important;
        }

        .meal-name {
            font-size: 12px;
        }

        .meal-foods {
            font-size: 11px;
            margin-left: 16px;
        }

        /* Mode scroll horizontal pour le tableau sur mobile */
        .card > div {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }

    /* Scrollbar discrète (ne s'affiche que si nécessaire) */
    .card > div::-webkit-scrollbar {
        height: 8px;
    }

    .card > div::-webkit-scrollbar-track {
        background: transparent;
    }

    .card > div::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
    }

    .card > div::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }

    /* Masquer scrollbar si pas nécessaire */
    .card > div {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 16px;">
    <h1 style="margin: 0; color: var(--text-primary); font-size: 32px; font-weight: 700;"><svg class="icon icon-xl"><use href="#icon-activity"/></svg> Récap</h1>
    <button onclick="window.print()" class="btn btn-primary"><svg class="icon"><use href="#icon-print"/></svg>️ Imprimer / PDF</button>
</div>

<div class="card">
    <form method="GET" action="{{ url_for('meals_recap') }}">
        <div class="period-selector">
            <div class="form-group">
                <label for="start_date">Date de début</label>
                <input type="date" class="form-control" id="start_date" name="start_date"
                       value="{{ start_date.isoformat() }}" required>
            </div>

            <div class="form-group">
                <label for="end_date">Date de fin</label>
                <input type="date" class="form-control" id="end_date" name="end_date"
                       value="{{ end_date.isoformat() }}" required>
            </div>

            <div class="recap-filter-buttons" style="display: flex; gap: 12px;">
            <button type="submit" class="btn btn-primary" style="padding: 12px 24px;">
                <svg class="icon"><use href="#icon-search"/></svg> Afficher
            </button>

            <button type="button" class="btn" style="background: var(--text-secondary); color: white; padding: 12px 24px;"
                    onclick="resetToDefault()">
                ↻ 2 dernières semaines
            </button>
            </div>
        </div>
    </form>

    <!-- Statistiques résumées -->
    <div class="recap-stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
    <div class="summary-stats" style="grid-template-columns: repeat(2, 1fr);">
        <div class="summary-card">
            <h3>Exceptions</h3>
            <div class="value">{{ stats.total_exceptions }}</div>
        </div>
        <div class="summary-card">
            <h3>Compensations</h3>
            <div class="value">{{ stats.total_equilibrages }}</div>
        </div>
    </div>
    </div>

    {% if days_data %}
    <div class="recap-table-wrapper" style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
        <table class="recap-table" style="display: block; overflow-x: auto; overflow-y: hidden;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th><svg class="icon icon-breakfast"><use href="#icon-breakfast"/></svg> Petit-déj</th>
                    {% if has_snack_morning %}
                    <th><svg class="icon icon-snack"><use href="#icon-snack"/></svg> Encas</th>
                    {% endif %}
                    <th><svg class="icon icon-lunch"><use href="#icon-lunch"/></svg> Déjeuner</th>
                    {% if has_snack_afternoon %}
                    <th><svg class="icon icon-gouter"><use href="#icon-gouter"/></svg> Goûter</th>
                    {% endif %}
                    <th><svg class="icon icon-dinner"><use href="#icon-dinner"/></svg> Dîner</th>
                    {% if current_user.track_activities %}
                    <th><svg class="icon"><use href="#icon-activity"/></svg> Activités</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for day in days_data %}
                <tr>
                    <td class="date-cell {% if day.is_today %}today{% endif %}">
                        {{ day.date.strftime('%d/%m/%Y') }}
                        <span class="day-name">{{ day.day_name }}</span>
                    </td>

                    <!-- Petit-déjeuner -->
                    <td class="meal-cell">
                        {% if day.meals['breakfast'] %}
                            {% if day.meals['breakfast'].is_none %}
                                <span style="color: #d1d5db;">—</span>
                            {% else %}
                                <div class="meal-name">
                                    {% if day.meals['breakfast'].qualification != 'normal' %}
                                        <span class="qualification-badge-small {{ day.meals['breakfast'].qualification }}">
                                            {% if day.meals['breakfast'].qualification == 'exception' %}<svg class="icon icon-sm"><use href="#icon-exception"/></svg>{% else %}<svg class="icon icon-sm"><use href="#icon-equilibrage"/></svg>{% endif %}
                                        </span>
                                    {% endif %}
                                    <span style="color: #10b981;">✓</span>
                                </div>

                                {% if day.meals['breakfast'].foods %}
                                    <ul class="meal-foods" style="list-style: none; padding: 0;">
                                        {% for food in day.meals['breakfast'].foods %}
                                            <li>• {{ food }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <span style="color: #d1d5db;">—</span>
                        {% endif %}
                    </td>

                    <!-- Encas (matin) - si existe dans la période ET pas que des "rien" -->
                    {% if has_snack_morning %}
                    <td class="meal-cell">
                        {% if day.meals['snack_morning'] %}
                            <div class="meal-name">
                                {% if day.meals['snack_morning'].qualification != 'normal' %}
                                    <span class="qualification-badge-small {{ day.meals['snack_morning'].qualification }}">
                                        {% if day.meals['snack_morning'].qualification == 'exception' %}<svg class="icon icon-sm"><use href="#icon-exception"/></svg>{% else %}<svg class="icon icon-sm"><use href="#icon-equilibrage"/></svg>{% endif %}
                                    </span>
                                {% endif %}

                                {% if day.meals['snack_morning'].is_none %}
                                    <span style="color: #9ca3af; font-style: italic;">Rien</span>
                                {% else %}
                                    <span style="color: #10b981;">✓</span>
                                {% endif %}
                            </div>

                            {% if not day.meals['snack_morning'].is_none and day.meals['snack_morning'].foods %}
                                <ul class="meal-foods" style="list-style: none; padding: 0;">
                                    {% for food in day.meals['snack_morning'].foods %}
                                        <li>• {{ food }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% else %}
                            <span style="color: #d1d5db;">—</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Déjeuner -->
                    <td class="meal-cell">
                        {% if day.meals['lunch'] %}
                            <div class="meal-name">
                                {% if day.meals['lunch'].qualification != 'normal' %}
                                    <span class="qualification-badge-small {{ day.meals['lunch'].qualification }}">
                                        {% if day.meals['lunch'].qualification == 'exception' %}<svg class="icon icon-sm"><use href="#icon-exception"/></svg>{% else %}<svg class="icon icon-sm"><use href="#icon-equilibrage"/></svg>{% endif %}
                                    </span>
                                {% endif %}

                                {% if day.meals['lunch'].is_none %}
                                    <span style="color: #9ca3af; font-style: italic;">Rien</span>
                                {% else %}
                                    <span style="color: #10b981;">✓</span>
                                {% endif %}
                            </div>

                            {% if not day.meals['lunch'].is_none and day.meals['lunch'].foods %}
                                <ul class="meal-foods" style="list-style: none; padding: 0;">
                                    {% for food in day.meals['lunch'].foods %}
                                        <li>• {{ food }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% else %}
                            <span style="color: #d1d5db;">—</span>
                        {% endif %}
                    </td>

                    <!-- Goûter - si existe dans la période ET pas que des "rien" -->
                    {% if has_snack_afternoon %}
                    <td class="meal-cell">
                        {% if day.meals['snack_afternoon'] %}
                            <div class="meal-name">
                                {% if day.meals['snack_afternoon'].qualification != 'normal' %}
                                    <span class="qualification-badge-small {{ day.meals['snack_afternoon'].qualification }}">
                                        {% if day.meals['snack_afternoon'].qualification == 'exception' %}<svg class="icon icon-sm"><use href="#icon-exception"/></svg>{% else %}<svg class="icon icon-sm"><use href="#icon-equilibrage"/></svg>{% endif %}
                                    </span>
                                {% endif %}

                                {% if day.meals['snack_afternoon'].is_none %}
                                    <span style="color: #9ca3af; font-style: italic;">Rien</span>
                                {% else %}
                                    <span style="color: #10b981;">✓</span>
                                {% endif %}
                            </div>

                            {% if not day.meals['snack_afternoon'].is_none and day.meals['snack_afternoon'].foods %}
                                <ul class="meal-foods" style="list-style: none; padding: 0;">
                                    {% for food in day.meals['snack_afternoon'].foods %}
                                        <li>• {{ food }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% else %}
                            <span style="color: #d1d5db;">—</span>
                        {% endif %}
                    </td>
                    {% endif %}

                    <!-- Dîner -->
                    <td class="meal-cell">
                        {% if day.meals['dinner'] %}
                            <div class="meal-name">
                                {% if day.meals['dinner'].qualification != 'normal' %}
                                    <span class="qualification-badge-small {{ day.meals['dinner'].qualification }}">
                                        {% if day.meals['dinner'].qualification == 'exception' %}<svg class="icon icon-sm"><use href="#icon-exception"/></svg>{% else %}<svg class="icon icon-sm"><use href="#icon-equilibrage"/></svg>{% endif %}
                                    </span>
                                {% endif %}

                                {% if day.meals['dinner'].is_none %}
                                    <span style="color: #9ca3af; font-style: italic;">Rien</span>
                                {% else %}
                                    <span style="color: #10b981;">✓</span>
                                {% endif %}
                            </div>

                            {% if not day.meals['dinner'].is_none and day.meals['dinner'].foods %}
                                <ul class="meal-foods" style="list-style: none; padding: 0;">
                                    {% for food in day.meals['dinner'].foods %}
                                        <li>• {{ food }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% else %}
                            <span style="color: #d1d5db;">—</span>
                        {% endif %}
                    </td>

                    <!-- Activités du jour -->
                    {% if current_user.track_activities %}
                    <td class="meal-cell">
                        {% if day.activities %}
                            {% for activity in day.activities %}
                                <div style="margin-bottom: 8px;">
                                    <div style="font-weight: 600; color: var(--text-primary); font-size: 13px;">
                                        {% if activity.activity_type == 'Marche' %}<svg class="icon icon-walk"><use href="#icon-walk"/></svg>
                                        {% elif activity.activity_type == 'Course' %}<svg class="icon icon-run"><use href="#icon-run"/></svg>
                                        {% elif activity.activity_type == 'Vélo' %}<svg class="icon icon-bike"><use href="#icon-bike"/></svg>
                                        {% elif activity.activity_type == 'Natation' %}<svg class="icon icon-swim"><use href="#icon-swim"/></svg>
                                        {% elif activity.activity_type == 'Musculation' %}<svg class="icon icon-gym"><use href="#icon-gym"/></svg>
                                        {% elif activity.activity_type == 'Yoga' %}<svg class="icon icon-yoga"><use href="#icon-yoga"/></svg>
                                        {% elif activity.activity_type == 'Pas' %}<svg class="icon"><use href="#icon-steps"/></svg>
                                        {% elif activity.activity_type == 'Ski' %}<svg class="icon icon-ski"><use href="#icon-ski"/></svg>
                                        {% else %}<svg class="icon"><use href="#icon-target"/></svg>
                                        {% endif %}
                                        {{ activity.activity_type }}
                                    </div>
                                    <div style="color: #6b7280; font-size: 12px; margin-left: 20px;">
                                        {% if activity.activity_type == 'Pas' %}
                                            {{ "{:,}".format(activity.steps).replace(',', ' ') }} pas
                                        {% else %}
                                            {% if activity.duration > 0 %}<svg class="icon"><use href="#icon-alert"/></svg> {{ activity.duration }}min{% endif %}
                                            {% if activity.calories_burned %} • <svg class="icon"><use href="#icon-fire"/></svg> {{ activity.calories_burned }}kcal{% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <span style="color: #d1d5db;">—</span>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"><svg class="icon"><use href="#icon-calendar"/></svg></div>
        <p style="font-size: 18px; margin: 0;">Aucune donnée enregistrée sur cette période</p>
        <p style="font-size: 14px; margin-top: 8px; color: #d1d5db;">Commence à saisir tes repas et activités !</p>
    </div>
    {% endif %}
</div>

<script>
    function resetToDefault() {
        const today = new Date();
        const twoWeeksAgo = new Date(today);
        twoWeeksAgo.setDate(today.getDate() - 14);

        document.getElementById('start_date').value = twoWeeksAgo.toISOString().split('T')[0];
        document.getElementById('end_date').value = today.toISOString().split('T')[0];

        document.querySelector('form').submit();
    }
</script>

{% endblock %}
