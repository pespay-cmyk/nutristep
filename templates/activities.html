{% extends "base.html" %}

{% block title %}Suivi des activit√©s - NutriStep{% endblock %}

{% block content %}

<style>
    /* RESPONSIVE MOBILE pour Activities */
    @media (max-width: 768px) {
        h1 {
            font-size: 24px !important;
        }

        .card h2 {
            font-size: 18px !important;
        }

        form > div {
            grid-template-columns: 1fr !important;
        }

        table {
            font-size: 12px;
            display: block;
            overflow-x: auto;
        }

        table th, table td {
            padding: 8px 4px;
        }

        /* Masquer colonne Note sur mobile */
        table th:nth-child(4),
        table td:nth-child(4) {
            display: none;
        }

        /* Bouton supprimer : ic√¥ne seule sans texte */
        .btn-delete-text {
            display: none;
        }

        .btn-small {
            padding: 8px;
            font-size: 11px;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px !important;
        }

        .stat-card .value {
            font-size: 28px;
        }

        .stat-card h3 {
            font-size: 11px;
        }
    }
</style>

<h1 style="margin-bottom: 30px; color: var(--text-primary); font-size: 32px; font-weight: 700;">
    <svg class="icon icon-xl"><use href="#icon-activity"/></svg> Activit√©s sportives
</h1>

{% if user.enable_garmin_import %}
<div style="margin-bottom: 20px;">
    <a href="{{ url_for('garmin_csv_import') }}" class="btn" style="background: linear-gradient(135deg, var(--secondary-start), var(--secondary-end)); color: white; display: inline-flex; align-items: center; gap: 8px;">
        <svg class="icon" style="width:18px;height:18px;"><use href="#icon-activity"/></svg>
        Importer depuis Garmin
    </a>
</div>
{% endif %}

<!-- Formulaire d'ajout -->
<div class="card">
    <h2><svg class="icon"><use href="#icon-plus"/></svg> Enregistrer une activit√©</h2>
    <form method="POST" action="{{ url_for('add_activity') }}">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div class="form-group">
                <label for="date">Date</label>
                <input type="date" class="form-control" id="date" name="date"
                       value="{{ today.isoformat() }}" required>
            </div>

            <div class="form-group">
                <label for="activity_type">Type d'activit√©</label>
                <select class="form-control" id="activity_type" name="activity_type" required onchange="toggleFields()">
                    <option value="">-- Choisir --</option>
                    <option value="Marche">Marche</option>
                    <option value="Course">Course</option>
                    <option value="V√©lo">V√©lo</option>
                    <option value="Natation">Natation</option>
                    <option value="Musculation">Musculation</option>
                    <option value="Yoga">Yoga</option>
                    <option value="Ski">Ski</option>
                    <option value="Pas">Pas quotidiens</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>

            <div class="form-group" id="steps_field" style="display: none;">
                <label for="steps">Nombre de pas</label>
                <input type="number" class="form-control" id="steps" name="steps"
                       placeholder="Ex: 8500" min="0">
            </div>

            <div class="form-group" id="duration_field">
                <label for="duration">Dur√©e (minutes)</label>
                <input type="number" class="form-control" id="duration" name="duration"
                       placeholder="Ex: 30" min="0">
            </div>

            <div class="form-group" id="calories_field">
                <label for="calories_burned">Calories br√ªl√©es (optionnel)</label>
                <input type="number" class="form-control" id="calories_burned" name="calories_burned"
                       placeholder="Ex: 250" min="0">
            </div>
        </div>

        <div class="form-group" id="note_field">
            <label for="note">Note (optionnel)</label>
            <input type="text" class="form-control" id="note" name="note"
                   placeholder="Ex: Parcours en for√™t, bon rythme">
        </div>

        <button type="submit" class="btn btn-primary"><svg class="icon"><use href="#icon-save"/></svg> Enregistrer</button>
    </form>
</div>

<!-- Graphique pas + activit√©s (30 derniers jours) -->
{% if entries %}
<div class="card">
    <h2><svg class="icon"><use href="#icon-steps"/></svg> Pas & activit√©s (30 derniers jours)</h2>
    <canvas id="stepsChart" height="100"></canvas>
    {% if steps_stats.average > 0 %}
    <div style="margin-top: 16px; text-align: center; padding: 12px; background: var(--bg-gradient-start); border-radius: 8px;">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Moyenne quotidienne de pas</div>
        <div style="font-size: 24px; font-weight: 700; color: var(--primary-start);">
            {{ "{:,}".format(steps_stats.average|int).replace(',', ' ') }} pas
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Historique -->
<div class="card">
    <h2>üìã Historique</h2>
    {% if entries %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>D√©tails</th>
                    <th>Note</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td style="font-weight: 600;">
                        {{ entry.date.strftime('%d/%m/%Y') }}
                        {% if entry.date == today %}
                            <span style="background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; padding: 2px 8px; border-radius: 6px; font-size: 11px; margin-left: 8px;">AUJOURD'HUI</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong style="color: var(--text-primary);">
                            {% if entry.activity_type == 'Marche' %}<svg class="icon"><use href="#icon-walk"/></svg>
                            {% elif entry.activity_type == 'Course' %}<svg class="icon"><use href="#icon-run"/></svg>
                            {% elif entry.activity_type == 'V√©lo' %}<svg class="icon"><use href="#icon-bike"/></svg>
                            {% elif entry.activity_type == 'Natation' %}<svg class="icon"><use href="#icon-swim"/></svg>
                            {% elif entry.activity_type == 'Musculation' %}<svg class="icon"><use href="#icon-gym"/></svg>
                            {% elif entry.activity_type == 'Yoga' %}<svg class="icon"><use href="#icon-yoga"/></svg>
                            {% elif entry.activity_type == 'Pas' %}<svg class="icon"><use href="#icon-steps"/></svg>
                            {% elif entry.activity_type == 'Ski' %}<svg class="icon"><use href="#icon-ski"/></svg>
                            {% else %}<svg class="icon"><use href="#icon-target"/></svg>
                            {% endif %}
                            {{ entry.activity_type }}
                        </strong>
                    </td>
                    <td>
                        {% if entry.activity_type == 'Pas' %}
                            <strong style="color: #10b981; font-size: 18px;">{{ entry.steps or 0 }}</strong> pas
                        {% else %}
                            {% if entry.duration %}
                                <span style="color: var(--text-secondary);"><svg class="icon"><use href="#icon-alert"/></svg> {{ entry.duration }} min</span>
                            {% endif %}
                            {% if entry.calories_burned %}
                                <span style="color: #ef4444; margin-left: 12px;"><svg class="icon"><use href="#icon-fire"/></svg> {{ entry.calories_burned }} kcal</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.note %}
                            <span style="color: #6b7280; font-size: 13px;">{{ entry.note }}</span>
                        {% else %}
                            <span style="color: #d1d5db;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('delete_activity', id=entry.id) }}"
                           class="btn btn-danger btn-small"
                           onclick="return confirm('Supprimer cette activit√© ?')">
                            <svg class="icon icon-sm"><use href="#icon-delete"/></svg><span class="btn-delete-text"> Supprimer</span>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;"><svg class="icon"><use href="#icon-activity"/></svg></div>
            <p style="color: #9ca3af; font-size: 18px; margin: 0;">Aucune activit√© enregistr√©e pour le moment</p>
            <p style="color: #d1d5db; font-size: 14px; margin-top: 8px;">Enregistre ta premi√®re activit√© !</p>
        </div>
    {% endif %}
</div>

<!-- Statistiques -->
{% if entries %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total activit√©s</h3>
        <div class="value">{{ entries|length }}</div>
        <div class="unit">jours actifs</div>
    </div>

    <div class="stat-card">
        <h3>Cette semaine</h3>
        <div class="value">{{ stats.week_count }}</div>
        <div class="unit">activit√©s</div>
    </div>

    {% if stats.total_steps > 0 %}
    <div class="stat-card">
        <h3>Total de pas</h3>
        <div class="value">{{ "{:,}".format(stats.total_steps).replace(',', ' ') }}</div>
        <div class="unit">pas</div>
    </div>
    {% endif %}

    {% if stats.total_calories > 0 %}
    <div class="stat-card">
        <h3>Calories br√ªl√©es</h3>
        <div class="value">{{ "{:,}".format(stats.total_calories).replace(',', ' ') }}</div>
        <div class="unit">kcal</div>
    </div>
    {% endif %}
</div>
{% endif %}

<script>
    function toggleFields() {
        const activityType = document.getElementById('activity_type').value;
        const stepsField = document.getElementById('steps_field');
        const durationField = document.getElementById('duration_field');
        const caloriesField = document.getElementById('calories_field');
        const stepsInput = document.getElementById('steps');
        const durationInput = document.getElementById('duration');

        if (activityType === 'Pas') {
            stepsField.style.display = 'block';
            durationField.style.display = 'none';
            caloriesField.style.display = 'none';
            stepsInput.required = true;
            durationInput.required = false;
            durationInput.value = '0';
        } else if (activityType) {
            stepsField.style.display = 'none';
            durationField.style.display = 'block';
            caloriesField.style.display = 'block';
            stepsInput.required = false;
            stepsInput.value = '';
            durationInput.required = true;
        }
    }
</script>

{% endblock %}

{% block extra_js %}
{% if entries %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const ctxSteps = document.getElementById('stepsChart').getContext('2d');

    // Donn√©es activit√©s par date pour enrichir le tooltip
    const activitiesByDate = {{ activities_by_date|tojson }};

    new Chart(ctxSteps, {
        type: 'line',
        data: {
            labels: {{ steps_data.dates|tojson }},
            datasets: [
                {
                    label: 'Pas quotidiens',
                    data: {{ steps_data.steps|tojson }},
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: function(context) {
                        const date = context.chart.data.labels[context.dataIndex];
                        return activitiesByDate[date] && activitiesByDate[date].length > 0 ? 10 : 6;
                    },
                    pointBackgroundColor: function(context) {
                        const date = context.chart.data.labels[context.dataIndex];
                        return activitiesByDate[date] && activitiesByDate[date].length > 0
                            ? 'rgb(16, 185, 129)' : 'rgb(59, 130, 246)';
                    },
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 12
                },
                {
                    label: 'Moyenne',
                    data: Array({{ steps_data.dates|length }}).fill({{ steps_stats.average }}),
                    borderColor: 'rgba(239, 68, 68, 0.5)',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                const steps = context.parsed.y;
                                return 'üë£ ' + steps.toLocaleString('fr-FR') + ' pas';
                            }
                            return 'Moyenne : ' + context.parsed.y.toLocaleString('fr-FR') + ' pas';
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 0) {
                                const date = context.label;
                                const activities = activitiesByDate[date] || [];
                                if (activities.length > 0) {
                                    let lines = ['\nActivit√©s :'];
                                    activities.forEach(act => {
                                        const emoji = getActivityEmoji(act.type);
                                        let line = emoji + ' ' + act.type;
                                        if (act.duration) line += ' (' + act.duration + 'min)';
                                        if (act.calories) line += ' - ' + act.calories + 'kcal';
                                        lines.push(line);
                                    });
                                    return lines;
                                }
                            }
                            return [];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('fr-FR');
                        }
                    }
                }
            }
        }
    });

    function getActivityEmoji(type) {
        const emojis = {
            'Marche': 'üö∂', 'Course': 'üèÉ', 'V√©lo': 'üö¥',
            'Natation': 'üèä', 'Musculation': 'üí™', 'Yoga': 'üßò',
            'Pas': 'üë£', 'Ski': '‚õ∑Ô∏è'
        };
        return emojis[type] || 'üéØ';
    }
</script>
{% endif %}
{% endblock %}
