{% extends "base.html" %}

{% block title %}Suivi du poids - NutriStep{% endblock %}

{% block content %}
<style>
    @media (max-width: 768px) {
        /* Masquer texte du bouton supprimer sur mobile */
        .btn-delete-text {
            display: none;
        }
    }
</style>

<h1 style="margin-bottom: 30px; color: var(--text-primary); font-size: 32px; font-weight: 700;"><svg class="icon icon-xl"><use href="#icon-balance"/></svg> Suivi du poids</h1>

<!-- Message si pas saisi depuis X jours -->
{% if days_since_last_entry and days_since_last_entry >= 7 %}
<div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; margin-bottom: 24px;">
    <p style="margin: 0; font-size: 16px; color: #92400e; font-weight: 600;">
        <svg class="icon"><use href="#icon-alert"/></svg> Tu n'as pas saisi ton poids depuis {{ days_since_last_entry }} jour{{ 's' if days_since_last_entry > 1 else '' }} !
        C'est le moment de te peser <svg class="icon icon-gym"><use href="#icon-gym"/></svg>
    </p>
</div>
{% endif %}

<!-- Message d'encouragement basé sur l'évolution -->
{% if weight_evolution_message %}
<div class="card" style="{{ weight_evolution_style }}; margin-bottom: 24px;">
    <p style="margin: 0; font-size: 16px; font-weight: 600;">
        {{ weight_evolution_message }}
    </p>
</div>
{% endif %}

<!-- Formulaire de saisie (seulement si pas déjà saisi aujourd'hui) -->
{% if not weight_today %}
<div class="card">
    <h2><svg class="icon"><use href="#icon-plus"/></svg> Enregistrer mon poids aujourd'hui</h2>
    <form method="POST" action="{{ url_for('add_weight') }}">
        <div class="weight-form-grid" style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="weight">Poids (kg)</label>
                <input type="number"
                       step="0.1"
                       class="form-control"
                       id="weight"
                       name="weight"
                       value="{{ last_weight }}"
                       required
                       autofocus
                       min="30"
                       max="300">
            </div>

            <button type="submit" class="btn btn-primary" style="padding: 14px 32px;">
                <svg class="icon"><use href="#icon-save"/></svg> Enregistrer
            </button>
        </div>
    </form>
</div>
{% else %}
<div class="card" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 4px solid #10b981;">
    <p style="margin: 0; font-size: 16px; color: #065f46; font-weight: 600;">
        <svg class="icon"><use href="#icon-check-circle"/></svg>Tu as déjà enregistré ton poids aujourd'hui : <strong>{{ weight_today.weight }} kg</strong>
    </p>
    <p style="margin-top: 12px; margin-bottom: 0; font-size: 14px; color: #047857;">
        Reviens demain pour enregistrer ton nouveau poids !
    </p>
</div>
{% endif %}

<!-- Sélecteur de période et options graphique -->
<div class="card">
    <div class="weight-chart-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;"><svg class="icon"><use href="#icon-activity"/></svg> Évolution du poids</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <!-- Sélecteur de période -->
            <select id="periodSelector" class="form-control" style="width: auto; padding: 10px 16px;" onchange="updateChart()">
                <option value="30">1 mois</option>
                <option value="60">2 mois</option>
                <option value="90">3 mois</option>
                <option value="240">8 mois</option>
                <option value="all">Depuis le début</option>
            </select>

            <!-- Option axe Y -->
            <label style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer;">
                <input type="checkbox" id="yAxisFromZero" onchange="updateChart()" style="cursor: pointer;">
                <svg class="icon" style="width:16px;height:16px;color:var(--text-secondary)"><use href="#icon-trend-down"/></svg>
                <span style="font-size: 14px; font-weight: 500; color: var(--text-secondary);">Axe à 0</span>
            </label>
        </div>
    </div>
    <canvas id="weightChart" height="80"></canvas>
</div>

<!-- Historique -->
<div class="card">
    <h2><svg class="icon"><use href="#icon-history"/></svg> Historique</h2>
    {% if entries %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Poids</th>
                    <th>Évolution</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td style="font-weight: 600;">
                        {{ entry.date.strftime('%d/%m/%Y') }}
                        {% if entry.date == today %}
                            <span style="background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; padding: 2px 8px; border-radius: 6px; font-size: 11px; margin-left: 8px;">AUJOURD'HUI</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong style="font-size: 18px; color: var(--text-primary);">{{ entry.weight }} kg</strong>
                    </td>
                    <td>
                        {% if loop.index < entries|length %}
                            {% set prev_weight = entries[loop.index].weight %}
                            {% set diff = entry.weight - prev_weight %}
                            {% if diff < 0 %}
                                <span style="color: #10b981; font-weight: 600;">
                                    <svg class="icon"><use href="#icon-trend-down"/></svg> {{ "%.1f"|format(diff|abs) }} kg
                                </span>
                            {% elif diff > 0 %}
                                <span style="color: #ef4444; font-weight: 600;">
                                    <svg class="icon"><use href="#icon-trend-up"/></svg> +{{ "%.1f"|format(diff) }} kg
                                </span>
                            {% else %}
                                <span style="color: #6b7280; font-weight: 600;">
                                    <svg class="icon"><use href="#icon-trend-stable"/></svg> Stable
                                </span>
                            {% endif %}
                        {% else %}
                            <span style="color: #9ca3af;">--</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.date == today %}
                        <form method="POST" action="{{ url_for('delete_weight', entry_id=entry.id) }}"
                              style="display: inline;"
                              onsubmit="return confirm('Supprimer la pesée du jour ?');">
                            <button type="submit"
                                    class="btn btn-danger btn-small"
                                    style="background: none; border: 1px solid #ef4444; color: #ef4444; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 4px;"
                                    onmouseover="this.style.background='#fee2e2'"
                                    onmouseout="this.style.background='transparent'">
                                <svg class="icon" style="width:14px;height:14px;"><use href="#icon-delete"/></svg>
                                <span class="btn-delete-text">Supprimer</span>
                            </button>
                        </form>
                        {% else %}
                        <span style="color: #d1d5db; font-size: 13px;">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;"><svg class="icon"><use href="#icon-weight"/></svg></div>
            <p style="color: #9ca3af; font-size: 18px; margin: 0;">Aucune pesée enregistrée pour le moment</p>
            <p style="color: #d1d5db; font-size: 14px; margin-top: 8px;">Commence dès maintenant ton suivi !</p>
        </div>
    {% endif %}
</div>

<!-- Statistiques -->
{% if entries|length > 1 %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Poids de départ</h3>
        <div class="value">{{ entries[-1].weight }}</div>
        <div class="unit">kg</div>
    </div>

    <div class="stat-card">
        <h3>Poids actuel</h3>
        <div class="value">{{ entries[0].weight }}</div>
        <div class="unit">kg</div>
    </div>

    <div class="stat-card">
        <h3>Évolution totale</h3>
        <div class="value">
            {% set total_diff = entries[0].weight - entries[-1].weight %}
            {{ "%.1f"|format(total_diff|abs) }}
        </div>
        <div class="unit">
    kg
    {% if total_diff < 0 %}
        <svg class="icon icon-trend-down" style="width:20px;height:20px;color:#10b981"><use href="#icon-trend-down"/></svg>
    {% elif total_diff > 0 %}
        <svg class="icon icon-trend-up" style="width:20px;height:20px;color:#ef4444"><use href="#icon-trend-up"/></svg>
    {% else %}
        <svg class="icon icon-trend-stable" style="width:20px;height:20px;color:#6b7280"><use href="#icon-trend-stable"/></svg>
    {% endif %}
</div>
    </div>

    <div class="stat-card">
        <h3>Nombre de pesées</h3>
        <div class="value">{{ entries|length }}</div>
        <div class="unit">jours</div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Données complètes depuis le backend
    const allWeightData = {
        dates: {{ all_dates|tojson }},
        weights: {{ all_weights|tojson }}
    };

    let chartInstance = null;

    function updateChart() {
        const period = document.getElementById('periodSelector').value;
        const fromZero = document.getElementById('yAxisFromZero').checked;

        // Filtrer les données selon la période
        let filteredData = { dates: [], weights: [] };

        if (period === 'all') {
            filteredData = allWeightData;
        } else {
            const days = parseInt(period);
            const startIndex = Math.max(0, allWeightData.dates.length - days);
            filteredData.dates = allWeightData.dates.slice(startIndex);
            filteredData.weights = allWeightData.weights.slice(startIndex);
        }

        // Calculer les limites de l'axe Y
        let minWeight = Math.min(...filteredData.weights);
        let maxWeight = Math.max(...filteredData.weights);

        // Assurer une envergure minimale de 10kg
        const range = maxWeight - minWeight;
        if (range < 10) {
            const midPoint = (minWeight + maxWeight) / 2;
            minWeight = midPoint - 5;
            maxWeight = midPoint + 5;
        }

        // Ajouter une marge de 5%
        const margin = (maxWeight - minWeight) * 0.05;

        // Configurer les limites Y
        const yAxisConfig = fromZero ? {
            beginAtZero: true
        } : {
            min: Math.max(0, minWeight - margin),
            max: maxWeight + margin
        };

        // Détruire l'ancien graphique s'il existe
        if (chartInstance) {
            chartInstance.destroy();
        }

        // Créer le nouveau graphique
        const ctx = document.getElementById('weightChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: filteredData.dates,
                datasets: [{
                    label: 'Poids (kg)',
                    data: filteredData.weights,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointBackgroundColor: 'rgb(16, 185, 129)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 16
                        },
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + ' kg';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ...yAxisConfig,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + ' kg';
                            },
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                }
            }
        });
    }

    // Initialiser le graphique au chargement
    {% if entries %}
    updateChart();
    {% endif %}
</script>
{% endblock %}
