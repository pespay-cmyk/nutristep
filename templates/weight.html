{% extends "base.html" %}

{% block title %}Suivi du poids - NutriStep{% endblock %}

{% block content %}
<h1 style="margin-bottom: 30px; color: var(--text-primary); font-size: 32px; font-weight: 700;">‚öñÔ∏è Suivi du poids</h1>

<!-- Message si pas saisi depuis X jours -->
{% if days_since_last_entry and days_since_last_entry > 0 %}
<div class="card" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b; margin-bottom: 24px;">
    <p style="margin: 0; font-size: 16px; color: #92400e; font-weight: 600;">
        ‚è∞ Tu n'as pas saisi ton poids depuis {{ days_since_last_entry }} jour{{ 's' if days_since_last_entry > 1 else '' }} ! 
        C'est le moment de te peser üí™
    </p>
</div>
{% endif %}

<!-- Message d'encouragement bas√© sur l'√©volution -->
{% if weight_evolution_message %}
<div class="card" style="{{ weight_evolution_style }}; margin-bottom: 24px;">
    <p style="margin: 0; font-size: 16px; font-weight: 600;">
        {{ weight_evolution_message }}
    </p>
</div>
{% endif %}

<!-- Formulaire de saisie (seulement si pas d√©j√† saisi aujourd'hui) -->
{% if not weight_today %}
<div class="card">
    <h2>‚ûï Enregistrer mon poids aujourd'hui</h2>
    <form method="POST" action="{{ url_for('add_weight') }}">
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="weight">Poids (kg)</label>
                <input type="number" 
                       step="0.1" 
                       class="form-control" 
                       id="weight" 
                       name="weight" 
                       value="{{ last_weight }}"
                       required 
                       autofocus
                       min="30"
                       max="300">
            </div>
            
            <button type="submit" class="btn btn-primary" style="padding: 14px 32px;">
                üíæ Enregistrer
            </button>
        </div>
    </form>
</div>
{% else %}
<div class="card" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-left: 4px solid #10b981;">
    <p style="margin: 0; font-size: 16px; color: #065f46; font-weight: 600;">
        ‚úÖ Tu as d√©j√† enregistr√© ton poids aujourd'hui : <strong>{{ weight_today.weight }} kg</strong>
    </p>
    <p style="margin-top: 12px; margin-bottom: 0; font-size: 14px; color: #047857;">
        Reviens demain pour enregistrer ton nouveau poids ! üòä
    </p>
</div>
{% endif %}

<!-- S√©lecteur de p√©riode et options graphique -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üìà √âvolution du poids</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <!-- S√©lecteur de p√©riode -->
            <select id="periodSelector" class="form-control" style="width: auto; padding: 10px 16px;" onchange="updateChart()">
                <option value="30">1 mois</option>
                <option value="60">2 mois</option>
                <option value="90">3 mois</option>
                <option value="240">8 mois</option>
                <option value="all">Depuis le d√©but</option>
            </select>
            
            <!-- Option axe Y -->
            <label style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer;">
                <input type="checkbox" id="yAxisFromZero" onchange="updateChart()" style="cursor: pointer;">
                <span style="font-size: 14px; font-weight: 500; color: var(--text-secondary);">Depuis 0</span>
            </label>
        </div>
    </div>
    <canvas id="weightChart" height="80"></canvas>
</div>

<!-- Historique -->
<div class="card">
    <h2>üìã Historique</h2>
    {% if entries %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Poids</th>
                    <th>√âvolution</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td style="font-weight: 600;">
                        {{ entry.date.strftime('%d/%m/%Y') }}
                        {% if entry.date == today %}
                            <span style="background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; padding: 2px 8px; border-radius: 6px; font-size: 11px; margin-left: 8px;">AUJOURD'HUI</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong style="font-size: 18px; color: var(--text-primary);">{{ entry.weight }} kg</strong>
                    </td>
                    <td>
                        {% if loop.index < entries|length %}
                            {% set prev_weight = entries[loop.index].weight %}
                            {% set diff = entry.weight - prev_weight %}
                            {% if diff < 0 %}
                                <span style="color: #10b981; font-weight: 600;">
                                    üìâ {{ "%.1f"|format(diff|abs) }} kg
                                </span>
                            {% elif diff > 0 %}
                                <span style="color: #ef4444; font-weight: 600;">
                                    üìà +{{ "%.1f"|format(diff) }} kg
                                </span>
                            {% else %}
                                <span style="color: #6b7280; font-weight: 600;">
                                    ‚û°Ô∏è Stable
                                </span>
                            {% endif %}
                        {% else %}
                            <span style="color: #9ca3af;">--</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('delete_weight', id=entry.id) }}" 
                           class="btn btn-danger btn-small"
                           onclick="return confirm('Supprimer cette entr√©e ?')">
                            üóëÔ∏è Supprimer
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">‚öñÔ∏è</div>
            <p style="color: #9ca3af; font-size: 18px; margin: 0;">Aucune pes√©e enregistr√©e pour le moment</p>
            <p style="color: #d1d5db; font-size: 14px; margin-top: 8px;">Commence d√®s maintenant ton suivi !</p>
        </div>
    {% endif %}
</div>

<!-- Statistiques -->
{% if entries|length > 1 %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Poids de d√©part</h3>
        <div class="value">{{ entries[-1].weight }}</div>
        <div class="unit">kg</div>
    </div>
    
    <div class="stat-card">
        <h3>Poids actuel</h3>
        <div class="value">{{ entries[0].weight }}</div>
        <div class="unit">kg</div>
    </div>
    
    <div class="stat-card">
        <h3>√âvolution totale</h3>
        <div class="value">
            {% set total_diff = entries[0].weight - entries[-1].weight %}
            {{ "%.1f"|format(total_diff|abs) }}
        </div>
        <div class="unit">
            kg {{ 'üìâ' if total_diff < 0 else 'üìà' if total_diff > 0 else '‚û°Ô∏è' }}
        </div>
    </div>

    <div class="stat-card">
        <h3>Nombre de pes√©es</h3>
        <div class="value">{{ entries|length }}</div>
        <div class="unit">jours</div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Donn√©es compl√®tes depuis le backend
    const allWeightData = {
        dates: {{ all_dates|tojson }},
        weights: {{ all_weights|tojson }}
    };
    
    let chartInstance = null;

    function updateChart() {
        const period = document.getElementById('periodSelector').value;
        const fromZero = document.getElementById('yAxisFromZero').checked;
        
        // Filtrer les donn√©es selon la p√©riode
        let filteredData = { dates: [], weights: [] };
        
        if (period === 'all') {
            filteredData = allWeightData;
        } else {
            const days = parseInt(period);
            const startIndex = Math.max(0, allWeightData.dates.length - days);
            filteredData.dates = allWeightData.dates.slice(startIndex);
            filteredData.weights = allWeightData.weights.slice(startIndex);
        }
        
        // Calculer les limites de l'axe Y
        let minWeight = Math.min(...filteredData.weights);
        let maxWeight = Math.max(...filteredData.weights);
        
        // Assurer une envergure minimale de 10kg
        const range = maxWeight - minWeight;
        if (range < 10) {
            const midPoint = (minWeight + maxWeight) / 2;
            minWeight = midPoint - 5;
            maxWeight = midPoint + 5;
        }
        
        // Ajouter une marge de 5%
        const margin = (maxWeight - minWeight) * 0.05;
        
        // Configurer les limites Y
        const yAxisConfig = fromZero ? {
            beginAtZero: true
        } : {
            min: Math.max(0, minWeight - margin),
            max: maxWeight + margin
        };
        
        // D√©truire l'ancien graphique s'il existe
        if (chartInstance) {
            chartInstance.destroy();
        }
        
        // Cr√©er le nouveau graphique
        const ctx = document.getElementById('weightChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: filteredData.dates,
                datasets: [{
                    label: 'Poids (kg)',
                    data: filteredData.weights,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointBackgroundColor: 'rgb(16, 185, 129)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 16
                        },
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + ' kg';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        ...yAxisConfig,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + ' kg';
                            },
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                }
            }
        });
    }
    
    // Initialiser le graphique au chargement
    {% if entries %}
    updateChart();
    {% endif %}
</script>
{% endblock %}
