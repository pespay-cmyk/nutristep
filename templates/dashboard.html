{% extends "base.html" %}

{% block title %}Dashboard - NutriStep{% endblock %}

{% block content %}
<h1><svg class="icon icon-xl" style="color: #f59e0b;"><use href="#icon-home"/></svg> Bonjour {{ session.username }} !</h1>

<!-- Stat unique : Poids actuel -->
<div class="stats-grid" style="grid-template-columns: 1fr;">
    <div class="stat-card">
        <h3>Poids actuel</h3>
        <div class="value">
            {% if latest_weight %}
                {{ latest_weight.weight }}
            {% else %}
                --
            {% endif %}
        </div>
        <div class="unit">kg</div>
    </div>
</div>

<!-- Graphique Poids -->
<div class="card">
    <h2><svg class="icon"><use href="#icon-weight"/></svg> √âvolution du poids (30 derniers jours)</h2>
<canvas id="weightChart" height="80"></canvas>
</div>

<!-- Graphique des pas (pleine largeur) -->
<div class="card">
    <h2><svg class="icon icon-steps"><use href="#icon-steps"/></svg> Nombre de pas (30 derniers jours)</h2>
    <canvas id="stepsChart" height="100"></canvas>
    {% if steps_stats.average > 0 %}
    <div style="margin-top: 16px; text-align: center; padding: 12px; background: var(--bg-gradient-start); border-radius: 8px;">
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">Moyenne quotidienne</div>
        <div style="font-size: 24px; font-weight: 700; color: var(--primary-start);">
            {{ "{:,}".format(steps_stats.average|int).replace(',', ' ') }} pas
        </div>
    </div>
    {% endif %}
</div>

<!-- Repas d'aujourd'hui + Activit√©s du mois (2 colonnes) -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">

    <!-- Repas d'aujourd'hui -->
    <div class="card">
        <h2><svg class="icon icon-meal"><use href="#icon-meal"/></svg> Repas d'aujourd'hui</h2>
        {% if today_meals %}
            <div style="display: grid; gap: 16px; margin-bottom: 20px;">
                {% for meal in today_meals %}
                <div style="padding: 16px; background: var(--bg-gradient-start); border-radius: 12px; border-left: 4px solid var(--primary-start);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span style="font-size: 24px;">
                            {% if meal.meal_type == 'breakfast' %}<svg class="icon icon-lg icon-breakfast"><use href="#icon-breakfast"/></svg>
                            {% elif meal.meal_type == 'snack_morning' %}<svg class="icon icon-lg icon-snack"><use href="#icon-snack"/></svg>
                            {% elif meal.meal_type == 'lunch' %}<svg class="icon icon-lg icon-lunch"><use href="#icon-lunch"/></svg>
                            {% elif meal.meal_type == 'snack_afternoon' %}<svg class="icon icon-lg icon-gouter"><use href="#icon-gouter"/></svg>
                            {% elif meal.meal_type == 'dinner' %}<svg class="icon icon-lg icon-dinner"><use href="#icon-dinner"/></svg>
                            {% else %}<svg class="icon icon-lg icon-meal"><use href="#icon-meal"/></svg>
                            {% endif %}
                        </span>
                        <div>
                            <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">
                                {% if meal.meal_type == 'breakfast' %}Petit-d√©jeuner
                                {% elif meal.meal_type == 'snack_morning' %}Encas (matin)
                                {% elif meal.meal_type == 'lunch' %}D√©jeuner
                                {% elif meal.meal_type == 'snack_afternoon' %}Go√ªter
                                {% elif meal.meal_type == 'dinner' %}D√Æner
                                {% else %}Repas
                                {% endif %}
                            </div>
                            {% if meal.is_none %}
                                <div style="color: #9ca3af; font-style: italic; font-size: 14px;">Rien mang√©</div>
                            {% else %}
                                <div style="color: var(--text-secondary); font-size: 14px;">
                                    {% for food in meal.get_foods_list() %}
                                        {{ food }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if meal.qualification != 'normal' %}
                                <span style="display: inline-block; margin-top: 4px; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;
                                    {% if meal.qualification == 'exception' %}background: #fef3c7; color: #92400e;
                                    {% else %}background: #dbeafe; color: #1e3a8a;
                                    {% endif %}">
                                    {% if meal.qualification == 'exception' %}<svg class="icon"><use href="#icon-exception"/></svg> Exception{% else %}<svg class="icon"><use href="#icon-equilibrage"/></svg> √âquilibrage{% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;"><svg class="icon"><use href="#icon-meal"/></svg>Ô∏è</div>
                <p style="color: #9ca3af; font-size: 16px; margin: 0;">Aucun repas enregistr√© aujourd'hui</p>
            </div>
        {% endif %}
        <a href="{{ url_for('meals') }}" class="btn btn-primary"><svg class="icon icon-plus"><use href="#icon-plus"/></svg> Ajouter un repas</a>
    </div>

    <!-- Activit√©s du mois -->
    <div class="card">
        <h2><svg class="icon icon-activity"><use href="#icon-activity"/></svg> Activit√©s du mois</h2>
        {% if month_activities %}
            <div style="max-height: 400px; overflow-y: auto;">
                {% for activity in month_activities %}
                <div style="padding: 12px; margin-bottom: 8px; background: var(--bg-gradient-start); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary);">
                            {% if activity.activity_type == 'Marche' %}<svg class="icon icon-walk"><use href="#icon-walk"/></svg>
                            {% elif activity.activity_type == 'Course' %}<svg class="icon icon-run"><use href="#icon-run"/></svg>
                            {% elif activity.activity_type == 'V√©lo' %}<svg class="icon icon-bike"><use href="#icon-bike"/></svg>
                            {% elif activity.activity_type == 'Natation' %}<svg class="icon icon-swim"><use href="#icon-swim"/></svg>
                            {% elif activity.activity_type == 'Musculation' %}<svg class="icon icon-gym"><use href="#icon-gym"/></svg>
                            {% elif activity.activity_type == 'Yoga' %}<svg class="icon icon-yoga"><use href="#icon-yoga"/></svg>
                            {% elif activity.activity_type == 'Pas' %}<svg class="icon icon-steps"><use href="#icon-steps"/></svg>
                            {% elif activity.activity_type == 'Ski' %}<svg class="icon icon-ski"><use href="#icon-ski"/></svg>
                            {% else %}<svg class="icon icon-activity"><use href="#icon-activity"/></svg>
                            {% endif %}
                            {{ activity.activity_type }}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            {{ activity.date.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 13px; color: var(--text-secondary);">
                        {% if activity.activity_type == 'Pas' %}
                            {{ "{:,}".format(activity.steps).replace(',', ' ') }} pas
                        {% else %}
                            {% if activity.duration > 0 %}{{ activity.duration }} min{% endif %}
                            {% if activity.calories_burned %} ‚Ä¢ {{ activity.calories_burned }} kcal{% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;"><svg class="icon"><use href="#icon-activity"/></svg></div>
                <p style="color: #9ca3af; font-size: 16px; margin: 0;">Aucune activit√© ce mois-ci</p>
            </div>
        {% endif %}
        <a href="{{ url_for('activities') }}" class="btn btn-primary" style="margin-top: 15px;"><svg class="icon icon-plus"><use href="#icon-plus"/></svg>Ajouter une activit√©</a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Graphique Poids
    const ctxWeight = document.getElementById('weightChart').getContext('2d');

    const weightData = {
        labels: [
            {% for entry in weight_history %}
                '{{ entry.date.strftime("%d/%m") }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Poids (kg)',
            data: [
                {% for entry in weight_history %}
                    {{ entry.weight }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: 'rgb(16, 185, 129)',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: 'rgb(16, 185, 129)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }]
    };

    new Chart(ctxWeight, {
        type: 'line',
        data: weightData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(1) + ' kg';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' kg';
                        }
                    }
                }
            }
        }
    });

    // Graphique des pas avec ic√¥nes d'activit√©s
    const ctxSteps = document.getElementById('stepsChart').getContext('2d');

    // Donn√©es des activit√©s par date (pour afficher les ic√¥nes)
    const activitiesByDate = {{ activities_by_date|tojson }};

    const stepsData = {
        labels: {{ steps_data.dates|tojson }},
        datasets: [
            {
                label: 'Pas quotidiens',
                data: {{ steps_data.steps|tojson }},
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true,
                pointRadius: function(context) {
                    const date = context.label;
                    // Si activit√© ce jour-l√† ‚Üí point plus gros
                    return activitiesByDate[date] && activitiesByDate[date].length > 0 ? 10 : 6;
                },
                pointBackgroundColor: function(context) {
                    const date = context.label;
                    // Si activit√© ce jour-l√† ‚Üí couleur diff√©rente
                    return activitiesByDate[date] && activitiesByDate[date].length > 0 ?
                        'rgb(16, 185, 129)' : 'rgb(59, 130, 246)';
                },
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointHoverRadius: 12,
                pointStyle: function(context) {
                    const date = context.label;
                    const activities = activitiesByDate[date];

                    // Si une seule activit√© ‚Üí afficher son ic√¥ne
                    if (activities && activities.length === 1) {
                        const emoji = getActivityEmoji(activities[0].type);
                        // Cr√©er une image avec l'emoji
                        const canvas = document.createElement('canvas');
                        canvas.width = 32;
                        canvas.height = 32;
                        const ctx = canvas.getContext('2d');
                        ctx.font = '24px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(emoji, 16, 16);

                        const img = new Image();
                        img.src = canvas.toDataURL();
                        return img;
                    }
                    return 'circle';
                }
            },
            {
                label: 'Moyenne',
                data: Array({{ steps_data.dates|length }}).fill({{ steps_stats.average }}),
                borderColor: 'rgba(239, 68, 68, 0.5)',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                fill: false
            }
        ]
    };

    new Chart(ctxSteps, {
        type: 'line',
        data: stepsData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                const steps = context.parsed.y;
                                const formattedSteps = steps.toLocaleString('fr-FR');
                                return 'üë£ ' + formattedSteps + ' pas';
                            }
                            return 'Moyenne : ' + context.parsed.y.toLocaleString('fr-FR') + ' pas';
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 0) {
                                const date = context.label;
                                const activities = activitiesByDate[date] || [];

                                if (activities.length > 0) {
                                    let lines = ['\nActivit√©s :'];
                                    activities.forEach(act => {
                                        const emoji = getActivityEmoji(act.type);
                                        let line = emoji + ' ' + act.type;
                                        if (act.duration) line += ' (' + act.duration + 'min)';
                                        if (act.calories) line += ' - ' + act.calories + 'kcal';
                                        lines.push(line);
                                    });
                                    return lines;
                                }
                            }
                            return [];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('fr-FR');
                        }
                    }
                }
            }
        }
    });

    function getActivityEmoji(type) {
        const emojis = {
            'Marche': 'üö∂',
            'Course': 'üèÉ',
            'V√©lo': 'üö¥',
            'Natation': 'üèä',
            'Musculation': 'üí™',
            'Yoga': 'üßò',
            'Pas': 'üë£',
            'Ski': '‚õ∑Ô∏è'
        };
        return emojis[type] || 'üéØ';
    }
</script>
{% endblock %}
